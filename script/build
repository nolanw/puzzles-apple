#!/bin/sh
set -e

root="$(CDPATH= cd -- "$(dirname -- "$0")"/.. && pwd)"
cd "$root"

job_count="$(sysctl -n hw.logicalcpu)"
scratch="$root"/scratch

build_halibut() {
    halibut_scratch="$scratch"/halibut &&
    mkdir -p "$halibut_scratch" &&
    cd "$halibut_scratch" &&
    echo "Configuring halibut…" &&
    cmake ../../halibut &&
    echo "Building halibut…" &&
    cmake --build . --config Release --parallel "$job_count"
}

build_puzzles() {
    puzzles_scratch="$scratch"/puzzles &&
    mkdir -p "$puzzles_scratch" &&
    cd "$puzzles_scratch" &&
    echo "Configuring puzzles…" &&
    cmake "$root"/puzzles -DCMAKE_PROGRAM_PATH="$halibut_scratch" &&
    echo "Building puzzles…" &&
    cmake --build . --config Release --parallel "$job_count" &&
    puzzles_app="$puzzles_scratch"/Puzzles.app
}

check_vars() {
    local missing=
    while read varname; do
        local tmp
        eval tmp=\$$varname
        [ "$tmp" ] || missing="$missing
    $varname"
    done <<'VARLIST'
        MAC_BUNDLE_IDENTIFIER
VARLIST
    [ -z "$missing" ] || die "Missing env vars (see README.md for explanation):$missing"
    : ${MAC_VERSION:="$("$root"/script/version)"}
}

die() {
    printf "%s\n" "$*" >&2
    exit 1
}

set_info_plist_values() {
    local info_plist="$puzzles_app"/Contents/Info.plist &&
    echo "Setting Info.plist values…" &&
    /usr/libexec/PlistBuddy -c \
        "Set :CFBundleIdentifier $MAC_BUNDLE_IDENTIFIER" \
        "$info_plist" &&
    /usr/libexec/PlistBuddy -c \
        "Set :CFBundleVersion $MAC_VERSION" \
        "$info_plist" &&
    /usr/libexec/PlistBuddy -c \
        "Set :CFBundleShortVersionString $version" \
        "$info_plist"
}

check_vars &&
build_halibut &&
build_puzzles &&
set_info_plist_values &&
echo "$puzzles_scratch" &&
echo "$puzzles_app"
